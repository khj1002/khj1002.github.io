<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒë¡€ í‚¤ì›Œë“œ ì•”ê¸°ì¥ (ë¡œì»¬ íŒŒì¼ ì—°ë™)</title>
    <style>
        /* (ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤.) */
        body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .container { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); width: 100%; max-width: 600px; text-align: center; border-top: 5px solid #2c3e50; }
        
        h1 { margin-bottom: 10px; color: #2c3e50; font-size: 1.6rem; }
        
        .filter-section { margin-bottom: 20px; }
        select { padding: 8px; font-size: 1rem; border-radius: 5px; border: 1px solid #ccc; outline: none; cursor: pointer; }

        .category-badge { display: inline-block; background: #34495e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 10px; }
        .question-box { background: #ecf0f1; padding: 25px; border-radius: 8px; margin-bottom: 20px; font-size: 1.1rem; font-weight: bold; color: #2c3e50; line-height: 1.6; word-break: keep-all;}
        
        input[type="text"] { width: 80%; padding: 12px; font-size: 1rem; border: 2px solid #ddd; border-radius: 5px; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: #3498db; }
        
        button { padding: 12px 25px; font-size: 1rem; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; transition: 0.2s; font-weight: bold; }
        .btn-submit { background-color: #2980b9; }
        .btn-submit:hover { background-color: #1c5980; }
        .btn-next { background-color: #27ae60; display: none; margin: 15px auto; }
        .btn-next:hover { background-color: #219150; }
        .btn-db-toggle { background-color: #e67e22; margin-bottom: 20px; } /* ì •ë‹µ DB ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-db-toggle:hover { background-color: #b8651c; }
        
        #result-message { margin-top: 15px; font-weight: bold; min-height: 24px; font-size: 1.05rem; }
        .correct { color: #27ae60; }
        .incorrect { color: #c0392b; }

        /* ë¡œë”© ë©”ì‹œì§€ */
        #loading-message { font-size: 1.2rem; color: #e67e22; margin-top: 50px; }

        /* ê´€ë¦¬ì íŒ¨ë„ ë° ì •ë‹µ DB íŒ¨ë„ */
        .panel { margin-top: 40px; width: 100%; max-width: 600px; border-top: 1px solid #ccc; padding-top: 15px; font-size: 0.85rem; color: #666; }
        .panel h3 { color: #2c3e50; }
        .panel table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .panel th { background: #f8f9fa; }
        .panel th, .panel td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        .panel td.id-col { width: 5%; text-align: center; }
        .panel td.keywords-col { color: #c0392b; font-weight: bold; width: 25%; }
        .btn-reset { background-color: #7f8c8d; font-size: 0.8rem; padding: 6px 12px; margin-bottom: 10px;}
    </style>
</head>
<body>

    <div class="container">
        <h1>âš–ï¸ íŒë¡€ í‚¤ì›Œë“œ ì•”ê¸°</h1>
        
        <button id="toggle-db-btn" class="btn-db-toggle" onclick="toggleAnswerDB()">ğŸ”‘ ë‹µì•ˆ DB ë³´ê¸°</button>
        
        <div class="filter-section">
            <label for="category-select">í•™ìŠµ ê³¼ëª© ì„ íƒ: </label>
            <select id="category-select" onchange="changeCategory()">
                <option value="í†µí•©">ğŸ§© í†µí•© ì¹´í…Œê³ ë¦¬ (ì „ì²´)</option>
                <option value="ë¯¼ì‚¬ë²•">ë¯¼ì‚¬ë²•</option>
                <option value="í˜•ì‚¬ë²•">í˜•ì‚¬ë²•</option>
                <option value="ê³µë²•">ê³µë²•(í—Œë²•/í–‰ì •)</option>
                <option value="ì¡°ì„¸ë²•">ì¡°ì„¸ë²•</option>
            </select>
        </div>

        <div id="quiz-area" style="display:none;">
            <div><span id="category-badge" class="category-badge">ê³¼ëª©</span></div>
            <div class="question-box" id="question-text"></div>

            <form id="quiz-form">
                <input type="text" id="answer-input" placeholder="í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
                <br>
                <button type="submit" class="btn-submit" id="submit-btn">ì •ë‹µ í™•ì¸</button>
            </form>

            <div id="result-message"></div>
            <button id="next-btn" class="btn-next">ë‹¤ìŒ íŒë¡€ ë³´ê¸° â¡ï¸</button>
        </div>
        
        <div id="loading-message">
            ë¬¸ì œ ë°ì´í„°ë¥¼ ë¡œì»¬ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>
    </div>
    
    <div id="answer-db-panel" class="panel" style="display:none;">
        <h3>ğŸ“‹ ì „ì²´ ë¬¸ì œ & ì •ë‹µ DB (<span id="db-category-name">í†µí•©</span>)</h3>
        <div id="answer-db-table"></div>
    </div>

    <div id="admin-panel" class="panel">
        <h3>ğŸ“Š í•™ìŠµ í˜„í™©íŒ</h3>
        <button class="btn-reset" onclick="resetData()">í•™ìŠµ ê¸°ë¡ ì´ˆê¸°í™”</button>
        <div id="debug-table"></div>
    </div>

    <script>
        // ==========================================
        // 1. ë¡œì»¬ CSV íŒŒì¼ ì´ë¦„ ì„¤ì •
        // ==========================================
        const LOCAL_CSV_FILE = "questions.csv"; 

        // ==========================================
        // 2. ì‹œìŠ¤í…œ ë³€ìˆ˜ ë° UI ìš”ì†Œ ì •ì˜
        // ==========================================
        let questionDB = [];
        let currentQuestion = null;
        let currentCategory = "í†µí•©"; 
        const historyKey = "lawQuizHistory_v1";

        const quizAreaEl = document.getElementById('quiz-area');
        const questionTextEl = document.getElementById('question-text');
        const answerDbPanelEl = document.getElementById('answer-db-panel'); // [ì‹ ê·œ]
        const answerDbTableEl = document.getElementById('answer-db-table'); // [ì‹ ê·œ]
        const dbCategoryNameEl = document.getElementById('db-category-name'); // [ì‹ ê·œ]
        const toggleDbBtn = document.getElementById('toggle-db-btn'); // [ì‹ ê·œ]
        const categoryBadgeEl = document.getElementById('category-badge');
        const answerInputEl = document.getElementById('answer-input');
        const resultMsgEl = document.getElementById('result-message');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        const categorySelectEl = document.getElementById('category-select');
        const loadingMessageEl = document.getElementById('loading-message');


        // ==========================================
        // 3. CSV ë°ì´í„° ë¡œë“œ ë° íŒŒì‹± ë¡œì§ (ë™ì¼)
        // ==========================================

        function parseCSV(csvText) {
            const lines = csvText.split('\n')
                .map(line => line.trim())
                .filter(line => line !== '' && line.replace(/\r/g, '') !== '');
                
            if (lines.length <= 1) return [];
            
            const data = [];
            let startIndex = 0;
            if (lines[0].toLowerCase().startsWith('id')) {
                startIndex = 1; 
            } else {
                startIndex = 0; 
            }
            
            for (let i = startIndex; i < lines.length; i++) {
                // ë°ì´í„°ë¥¼ ì‰¼í‘œ(,)ë¡œ ë¶„ë¦¬
                const values = lines[i].split(',');

                if (values.length < 4) continue;
                
                const row = {};
                try {
                    row.id = parseInt(values[0].trim());
                    row.category = values[1].trim();
                    // CSVì—ì„œ í…ìŠ¤íŠ¸ê°€ í°ë”°ì˜´í‘œë¡œ ê°ì‹¸ì—¬ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì œê±°
                    row.text = values[2].trim().replace(/^"|"$/g, ''); 
                    
                    row.keywords = values[3] 
                                    ? values[3].split(',').map(k => k.trim().replace(/^"|"$/g, '')) 
                                    : [];
                } catch (e) {
                    console.error("CSV íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e, "ë¼ì¸:", lines[i]);
                    continue; 
                }
                
                if (!isNaN(row.id) && row.id > 0) {
                    data.push(row);
                }
            }
            return data;
        }

        // ë¡œì»¬ íŒŒì¼ì„ ë¹„ë™ê¸°ë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ (XMLHttpRequest ì‚¬ìš©)
        function loadQuestionData() {
            loadingMessageEl.textContent = `ë¬¸ì œ ë°ì´í„°ë¥¼ ${LOCAL_CSV_FILE} ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...`;
            
            const xhr = new XMLHttpRequest();
            xhr.open("GET", LOCAL_CSV_FILE, true);
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    const csvText = xhr.responseText;
                    questionDB = parseCSV(csvText);

                    if (questionDB.length === 0) {
                        loadingMessageEl.textContent = `âš ï¸ ë¬¸ì œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆê±°ë‚˜ íŒŒì¼(${LOCAL_CSV_FILE})ì— ìœ íš¨í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.`;
                        return;
                    }

                    // ë°ì´í„° ë¡œë“œ ì„±ê³µ
                    loadingMessageEl.style.display = 'none';
                    quizAreaEl.style.display = 'block';
                    loadQuestion();
                    renderAdminTable();
                    renderAnswerDB(); // [ì‹ ê·œ] ë°ì´í„° ë¡œë“œ í›„ ì •ë‹µ DBë„ ì´ˆê¸° ë Œë”ë§
                    toggleDbBtn.disabled = false;

                } else {
                    loadingMessageEl.innerHTML = `âŒ íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜: ${LOCAL_CSV_FILE} íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                    toggleDbBtn.disabled = true;
                }
            };
            
            xhr.onerror = function() {
                loadingMessageEl.innerHTML = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`;
                toggleDbBtn.disabled = true;
            };

            xhr.send(null);
        }


        // ==========================================
        // 4. [ì‹ ê·œ] ì •ë‹µ DB íŒ¨ë„ ë¡œì§
        // ==========================================
        
        // ì •ë‹µ DB íŒ¨ë„ ì—´ê¸°/ë‹«ê¸° í† ê¸€
        function toggleAnswerDB() {
            const isVisible = answerDbPanelEl.style.display !== 'none';
            if (isVisible) {
                answerDbPanelEl.style.display = 'none';
                toggleDbBtn.textContent = 'ğŸ”‘ ë‹µì•ˆ DB ë³´ê¸°';
            } else {
                renderAnswerDB(); // ì—´ ë•Œë§ˆë‹¤ ìµœì‹  ì¹´í…Œê³ ë¦¬ë¡œ ê°±ì‹ 
                answerDbPanelEl.style.display = 'block';
                toggleDbBtn.textContent = 'âŒ ë‹µì•ˆ DB ìˆ¨ê¸°ê¸°';
            }
        }

        // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ì— ë§ì¶° ì •ë‹µ í…Œì´ë¸” ë Œë”ë§
        function renderAnswerDB() {
            const selectedCategory = categorySelectEl.value;
            dbCategoryNameEl.textContent = selectedCategory === 'í†µí•©' ? 'ì „ì²´' : selectedCategory;
            
            let filteredDB = questionDB;
            if (selectedCategory !== "í†µí•©") {
                filteredDB = questionDB.filter(q => q.category === selectedCategory);
            }

            let html = `<table><thead><tr><th>ID</th><th>ë¬¸ì œ ë‚´ìš©</th><th>ì •ë‹µ í‚¤ì›Œë“œ</th></tr></thead><tbody>`;

            if (filteredDB.length === 0) {
                html += `<tr><td colspan="3" style="text-align:center;">ì„ íƒí•˜ì‹  ì¹´í…Œê³ ë¦¬ì— ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            } else {
                filteredDB.forEach(q => {
                    const keywordsString = q.keywords.join(' / ');
                    html += `<tr>
                        <td class="id-col">${q.id}</td>
                        <td>${q.text}</td>
                        <td class="keywords-col">${keywordsString}</td>
                    </tr>`;
                });
            }
            html += `</tbody></table>`;
            answerDbTableEl.innerHTML = html;
        }

        // ==========================================
        // 5. ê¸°ì¡´ í€´ì¦ˆ/ê´€ë¦¬ ë¡œì§
        // ==========================================
        
        function getUserHistory() {
            const history = localStorage.getItem(historyKey);
            return history ? JSON.parse(history) : {};
        }

        function saveUserHistory(history) {
            localStorage.setItem(historyKey, JSON.stringify(history));
            renderAdminTable();
        }

        function changeCategory() {
            currentCategory = categorySelectEl.value;
            loadQuestion(); 
            // [ì‹ ê·œ] ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ì •ë‹µ DB íŒ¨ë„ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‚´ìš© ê°±ì‹ 
            if (answerDbPanelEl.style.display !== 'none') {
                 renderAnswerDB(); 
            }
        }

        function selectNextQuestion() {
            const history = getUserHistory();
            
            let candidates = questionDB;
            if (currentCategory !== "í†µí•©") {
                candidates = questionDB.filter(q => q.category === currentCategory);
            }

            if (candidates.length === 0) return null; 

            const rankedQuestions = candidates.map(q => {
                const record = history[q.id];
                if (!record) {
                    return { ...q, priority: 9999 };
                }
                const totalAttempts = record.correct + record.incorrect;
                const failRate = totalAttempts === 0 ? 0 : (record.incorrect / totalAttempts);
                return { ...q, priority: failRate };
            });

            // ì •ë ¬ (ì˜¤ë‹µë¥ ì´ ë†’ì€ ìˆœì„œ -> IDìˆœ)
            rankedQuestions.sort((a, b) => {
                if (b.priority !== a.priority) return b.priority - a.priority;
                return a.id - b.id;
            });

            return rankedQuestions[0];
        }

        function loadQuestion() {
            currentQuestion = selectNextQuestion();

            // UI ì´ˆê¸°í™”
            resultMsgEl.textContent = "";
            submitBtn.style.display = "inline-block";
            nextBtn.style.display = "none";
            answerInputEl.disabled = false;
            answerInputEl.value = "";
            answerInputEl.focus();

            if (!currentQuestion) {
                questionTextEl.textContent = "ì„ íƒí•˜ì‹  ê³¼ëª©ì— ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. CSV íŒŒì¼ì— ë¬¸ì œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.";
                categoryBadgeEl.style.display = 'none';
                submitBtn.style.display = 'none';
                answerInputEl.disabled = true;
                return;
            }

            // ë¬¸ì œ í‘œì‹œ
            categoryBadgeEl.style.display = 'inline-block';
            categoryBadgeEl.textContent = currentQuestion.category;
            questionTextEl.textContent = currentQuestion.text;
        }

        function checkAnswer(userAnswer, keywords) {
            if (!userAnswer || keywords.length === 0) return false;
            const normalizedAnswer = userAnswer.toLowerCase().replace(/\s+/g, '');
            return keywords.every(keyword => {
                const normalizedKeyword = keyword.toLowerCase().replace(/\s+/g, '');
                return normalizedAnswer.includes(normalizedKeyword);
            });
        }

        document.getElementById('quiz-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!currentQuestion) return;

            const userAnswer = answerInputEl.value;
            if (!userAnswer.trim()) {
                alert("í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const isCorrect = checkAnswer(userAnswer, currentQuestion.keywords);
            
            // ê¸°ë¡ ì €ì¥
            const history = getUserHistory();
            if (!history[currentQuestion.id]) history[currentQuestion.id] = { correct: 0, incorrect: 0 };
            
            const keywordsString = currentQuestion.keywords.join(' / '); // ì •ë‹µ í‘œì‹œìš©

            if (isCorrect) {
                history[currentQuestion.id].correct++;
                resultMsgEl.innerHTML = `<span class="correct">â­• ì •ë‹µì…ë‹ˆë‹¤! (í‚¤ì›Œë“œ: ${keywordsString})</span>`;
                answerInputEl.disabled = true;
                submitBtn.style.display = "none";
                nextBtn.style.display = "block";
                nextBtn.focus();
            } else {
                history[currentQuestion.id].incorrect++;
                resultMsgEl.innerHTML = `<span class="incorrect">âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”.</span>`;
                answerInputEl.focus();
            }
            saveUserHistory(history);
        });

        nextBtn.addEventListener('click', loadQuestion);

        function resetData() {
            if(confirm("ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¡œì»¬ íŒŒì¼ì˜ ë¬¸ì œëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)")) {
                localStorage.removeItem(historyKey);
                loadQuestionData(); 
            }
        }

        function renderAdminTable() {
            const history = getUserHistory();
            const tableContainer = document.getElementById('debug-table');
            
            let html = `<table><thead><tr><th>ê³¼ëª©</th><th>ID</th><th>ë¬¸ì œ(ìš”ì•½)</th><th>ì •ë‹µ/ì˜¤ë‹µ</th><th>ì˜¤ë‹µë¥ </th></tr></thead><tbody>`;
            
            questionDB.forEach(q => {
                const h = history[q.id] || { correct: 0, incorrect: 0 };
                const total = h.correct + h.incorrect;
                const rate = total === 0 ? 0 : (h.incorrect / total) * 100;
                
                html += `<tr>
                    <td>${q.category}</td>
                    <td>${q.id}</td>
                    <td style="text-align:left;">${q.text.substring(0, 15)}...</td>
                    <td>${h.correct}/${h.incorrect}</td>
                    <td>${total === 0 ? "-" : rate.toFixed(0) + "%"}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            tableContainer.innerHTML = html;
        }

        // ==========================================
        // 6. ì‹¤í–‰ ì‹œì‘
        // ==========================================
        loadQuestionData();

    </script>
</body>
</html>
